[phases.setup]
nixPkgs = [
  "php83",
  "php83Extensions.pdo",
  "php83Extensions.pdo_sqlite",
  "php83Extensions.sqlite3",
  "php83Extensions.mbstring",
  "php83Extensions.tokenizer",
  "php83Extensions.xml",
  "php83Extensions.curl",
  "php83Extensions.fileinfo",
  "php83Extensions.openssl",
  "php83Extensions.zip",
  "php83Extensions.bcmath",
  "php83Extensions.ctype",
  "php83Extensions.json",
  "php83Extensions.mysqli",
  "php83Extensions.pdo_mysql",
  "php83Extensions.gd",
  "php83Extensions.exif",
  "php83Extensions.ftp",
  "php83Extensions.opcache",
  "nginx",
  "supervisor",
  "nodejs_22",
  "npm-9_x"
]

[phases.install]
cmds = [
    "cd /app/backend && composer install --no-interaction --prefer-dist --optimize-autoloader",
    "cd /app/frontend && npm ci"
]

[phases.build]
cmds = [
    "cd /app/frontend && npm run build",
    "mkdir -p /app/backend/public && cp -r /app/frontend/dist/* /app/backend/public/",
    "mkdir -p /etc/supervisor/conf.d",
    "mkdir -p /run/php",
    "mkdir -p /var/log/nginx",
    "mkdir -p /var/lib/nginx",
    "cp /assets/start.sh /start.sh",
    "cp /assets/supervisord.conf /etc/supervisor/supervisord.conf",
    "cp /assets/worker-nginx.conf /etc/supervisor/conf.d/nginx.conf",
    "cp /assets/worker-phpfpm.conf /etc/supervisor/conf.d/php-fpm.conf",
    "cp /assets/worker-laravel.conf /etc/supervisor/conf.d/laravel-worker.conf",
    "cp /assets/php-fpm.conf /etc/php-fpm.conf",
    "cp /assets/nginx.template.conf /etc/nginx/nginx.template.conf",
    "chmod +x /start.sh"
]

[start]
cmd = '/start.sh'

[staticAssets]
"start.sh" = '''
#!/bin/bash

# Setup environment
export PHP_INI_SCAN_DIR=/usr/local/etc/php/conf.d

# Create necessary directories
mkdir -p /var/log/supervisor
mkdir -p /run/php
mkdir -p /var/log/nginx
mkdir -p /var/lib/nginx
mkdir -p /var/www/html/storage/app/public
mkdir -p /var/www/html/storage/framework/cache
mkdir -p /var/www/html/storage/framework/sessions
mkdir -p /var/www/html/storage/framework/views
mkdir -p /var/www/html/storage/logs
mkdir -p /var/www/html/bootstrap/cache

# Copy backend to working directory
cp -r /app/backend/* /var/www/html/

# Set proper permissions
chown -R www-data:www-data /var/www/html/storage
chown -R www-data:www-data /var/www/html/bootstrap/cache
chmod -R 775 /var/www/html/storage
chmod -R 775 /var/www/html/bootstrap/cache

# Setup environment file if it doesn't exist
if [ ! -f /var/www/html/.env ]; then
    cp /var/www/html/.env.example /var/www/html/.env
fi

# Generate application key if not set
if [ -z "$APP_KEY" ]; then
    cd /var/www/html && php artisan key:generate --force
fi

# Create SQLite database if using SQLite and DB_DATABASE is not set
if [ "$DB_CONNECTION" = "sqlite" ] || [ -z "$DB_CONNECTION" ]; then
    if [ ! -f /var/www/html/database/database.sqlite ]; then
        touch /var/www/html/database/database.sqlite
        chown www-data:www-data /var/www/html/database/database.sqlite
        chmod 664 /var/www/html/database/database.sqlite
    fi
fi

# Run migrations
cd /var/www/html && php artisan migrate --force

# Optimize Laravel
cd /var/www/html && php artisan config:cache
cd /var/www/html && php artisan route:cache
cd /var/www/html && php artisan view:cache
cd /var/www/html && php artisan event:cache

# Process Nginx configuration template
envsubst '$PORT' < /etc/nginx/nginx.template.conf > /etc/nginx/nginx.conf

# Start supervisor
/usr/bin/supervisord -c /etc/supervisor/supervisord.conf -n
'''

"supervisord.conf" = '''
[supervisord]
nodaemon=true
user=root
logfile=/var/log/supervisor/supervisord.log
pidfile=/run/supervisord.pid

[unix_http_server]
file=/run/supervisor.sock
chmod=0700

[supervisorctl]
serverurl=unix:///run/supervisor.sock

[rpcinterface:supervisor]
supervisor.rpcinterface_factory=supervisor.rpcinterface:make_main_rpcinterface

[include]
files = /etc/supervisor/conf.d/*.conf
'''

"worker-nginx.conf" = '''
[program:nginx]
command=/usr/sbin/nginx -g "daemon off;"
autostart=true
autorestart=true
priority=10
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
'''

"worker-phpfpm.conf" = '''
[program:php-fpm]
command=/usr/sbin/php-fpm -F --fpm-config /etc/php-fpm.conf
autostart=true
autorestart=true
priority=5
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
'''

"worker-laravel.conf" = '''
[program:laravel-worker]
process_name=%(program_name)s_%(process_num)02d
command=php /var/www/html/artisan queue:work --sleep=3 --tries=3 --max-time=3600
autostart=true
autorestart=true
user=www-data
numprocs=2
redirect_stderr=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
stopwaitsecs=3600
'''

"php-fpm.conf" = '''
[global]
pid = /run/php/php-fpm.pid
daemonize = no

[www]
user = www-data
group = www-data
listen = /run/php/php-fpm.sock
listen.owner = www-data
listen.group = www-data
listen.mode = 0660
pm = dynamic
pm.max_children = 50
pm.start_servers = 5
pm.min_spare_servers = 5
pm.max_spare_servers = 35
pm.max_requests = 500
clear_env = no
catch_workers_output = yes
decorate_workers_output = no
'''

"nginx.template.conf" = '''
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    client_max_body_size 64M;

    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml application/json application/javascript application/rss+xml application/atom+xml image/svg+xml;

    server {
        listen ${PORT};
        server_name _;
        root /var/www/html/public;
        index index.php index.html;

        location / {
            try_files $uri $uri/ /index.php?$query_string;
        }

        location = /favicon.ico { access_log off; log_not_found off; }
        location = /robots.txt  { access_log off; log_not_found off; }

        error_page 404 /index.php;

        location ~ \\.php$ {
            fastcgi_pass unix:/run/php/php-fpm.sock;
            fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
            include fastcgi_params;
            fastcgi_hide_header X-Powered-By;
        }

        location ~ /\\.(?!well-known).* {
            deny all;
        }
    }
}
'''
